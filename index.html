<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Your Password</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      min-height: 100vh; 
      background: #f7f7f7; 
      margin: 0;
      padding: 20px;
    }
    .container { 
      background: #fff; 
      padding: 30px; 
      border-radius: 10px; 
      box-shadow: 0 0 15px rgba(0,0,0,0.1); 
      text-align: center; 
      width: 100%;
      max-width: 400px;
    }
    .input-wrapper { 
      position: relative; 
      margin: 15px 0;
    }
    input { 
      width: 100%; 
      padding: 12px 40px 12px 12px; 
      font-size: 16px; 
      border: 1px solid #ddd;
      border-radius: 5px;
      box-sizing: border-box;
    }
    input:focus {
      outline: none;
      border-color: #4CAF50;
    }
    input:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
    }
    .eye-btn { 
      position: absolute; 
      right: 12px; 
      top: 50%; 
      transform: translateY(-50%); 
      cursor: pointer; 
      user-select: none;
      font-size: 18px;
    }
    button { 
      width: 100%;
      padding: 12px 20px; 
      font-size: 16px; 
      cursor: pointer; 
      margin-top: 15px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: bold;
    }
    button:hover:not(:disabled) {
      background: #45a049;
    }
    button:disabled { 
      background: #ccc; 
      cursor: not-allowed; 
    }
    h1 { 
      margin-bottom: 20px; 
      color: #333;
    }
    #message { 
      color: red; 
      margin-top: 15px; 
      min-height: 20px; 
      font-size: 14px;
    }
    .success { color: green !important; }
    .logo {
      width: 150px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Uncomment if you upload logo.png to the repo -->
    <!-- <img src="logo.png" alt="Turning Point Logo" class="logo"> -->
    
    <h1>Reset Your Password</h1>
    
    <div class="input-wrapper">
      <input type="password" id="password1" placeholder="Enter new password" disabled/>
      <span class="eye-btn" onclick="togglePassword('password1')">üëÅÔ∏è</span>
    </div>
    
    <div class="input-wrapper">
      <input type="password" id="password2" placeholder="Confirm new password" disabled/>
      <span class="eye-btn" onclick="togglePassword('password2')">üëÅÔ∏è</span>
    </div>
    
    <button id="resetBtn" disabled>Reset Password</button>
    <p id="message">Checking reset link...</p>
  </div>

  <!-- FIXED: Load Supabase library from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    // FIXED: Correct Supabase configuration
    const SUPABASE_URL = 'https://yljmowhxowqulqqwzhuc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlsam1vd2h4b3dxdWxxcXd6aHVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc3MTQ0NzgsImV4cCI6MjA1MzI5MDQ3OH0.J_Yv_O2KqX0J7f6NpUmOzSKjStRLwuYVEV3mXFrR7xE';
    
    // FIXED: Proper Supabase initialization
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Toggle password visibility
    function togglePassword(fieldId) {
      const field = document.getElementById(fieldId);
      field.type = field.type === 'password' ? 'text' : 'password';
    }

    // Main logic
    window.onload = async () => {
      const password1 = document.getElementById('password1');
      const password2 = document.getElementById('password2');
      const resetBtn = document.getElementById('resetBtn');
      const message = document.getElementById('message');

      // Extract token from URL hash
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const access_token = params.get('access_token');
      const refresh_token = params.get('refresh_token');
      const type = params.get('type');

      console.log('Token found:', !!access_token);
      console.log('Type:', type);

      // Check if valid reset link
      if (!access_token || type !== 'recovery') {
        message.textContent = '‚ùå Reset link is missing or invalid. Please request a new one.';
        return;
      }

      // FIXED: Set the session with the token (THIS IS THE KEY FIX!)
      try {
        const { data, error } = await supabaseClient.auth.setSession({
          access_token: access_token,
          refresh_token: refresh_token
        });

        if (error) throw error;

        message.textContent = '‚úÖ Link verified! Enter your new password.';
        message.style.color = 'green';

        // Enable password fields
        password1.disabled = false;
        password2.disabled = false;

      } catch (error) {
        console.error('Session error:', error);
        message.textContent = '‚ùå Invalid or expired link. Please request a new reset.';
        return;
      }

      // Password validation
      function checkPasswords() {
        const pass1 = password1.value;
        const pass2 = password2.value;

        if (!pass1 || !pass2) {
          resetBtn.disabled = true;
          message.textContent = '';
          return;
        }

        if (pass1.length < 6) {
          resetBtn.disabled = true;
          message.textContent = '‚ö†Ô∏è Password must be at least 6 characters';
          message.style.color = 'orange';
          return;
        }

        if (pass1 !== pass2) {
          resetBtn.disabled = true;
          message.textContent = '‚ö†Ô∏è Passwords do not match';
          message.style.color = 'orange';
          return;
        }

        // All good!
        resetBtn.disabled = false;
        message.textContent = '‚úì Passwords match';
        message.style.color = 'green';
      }

      password1.addEventListener('input', checkPasswords);
      password2.addEventListener('input', checkPasswords);

      // Reset password button
      resetBtn.addEventListener('click', async () => {
        resetBtn.disabled = true;
        resetBtn.textContent = 'Resetting...';
        message.textContent = 'Updating your password...';
        message.style.color = 'blue';

        try {
          // FIXED: Correct API call
          const { data, error } = await supabaseClient.auth.updateUser({
            password: password1.value
          });

          if (error) throw error;

          // Success!
          message.style.color = 'green';
          message.textContent = 'üéâ Password reset successfully! Redirecting...';
          resetBtn.textContent = '‚úì Success';
          
          // Redirect after 2 seconds
          setTimeout(() => {
            window.location.href = 'https://the-turning-point-booking-app.onrender.com';
          }, 2000);

        } catch (error) {
          console.error('Reset error:', error);
          message.style.color = 'red';
          message.textContent = '‚ùå Error: ' + error.message;
          resetBtn.disabled = false;
          resetBtn.textContent = 'Reset Password';
        }
      });
    };
  </script>
</body>
</html>
