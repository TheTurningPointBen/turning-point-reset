<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Your Password</title>
  <style>
    body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #f7f7f7; }
    .container { background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); text-align: center; width: 350px; }
    input { width: 100%; padding: 10px; margin: 10px 0; font-size: 16px; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-top: 10px; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .eye-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; }
    h1 { margin-bottom: 20px; }
    #message { color: red; margin-top: 10px; min-height: 20px; }
    .input-wrapper { position: relative; }
  </style>
</head>
<body>
  <div class="container">
    <img src="logo.png" alt="Turning Point Logo" style="width:150px;margin-bottom:20px;">
    <h1>Reset Your Password</h1>

    <div class="input-wrapper">
      <input type="password" id="password1" placeholder="Enter new password" disabled/>
      <span class="eye-btn" onclick="togglePassword('password1')">üëÅÔ∏è</span>
    </div>
    
    <div class="input-wrapper">
      <input type="password" id="password2" placeholder="Confirm new password" disabled/>
      <span class="eye-btn" onclick="togglePassword('password2')">üëÅÔ∏è</span>
    </div>

    <button id="resetBtn" disabled>Reset Password</button>
    <p id="message">Checking reset link...</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = 'https://yljmowhxowqulqqwzhuc.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_qO_rJa19R_kgxdzWwTuyJg_4JIsdpSh';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    window.onload = async () => {
      const password1 = document.getElementById('password1');
      const password2 = document.getElementById('password2');
      const resetBtn = document.getElementById('resetBtn');
      const message = document.getElementById('message');

      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const access_token = params.get('access_token');

      if(!access_token) {
        message.textContent = 'Reset link missing or invalid.';
        return;
      }

      // Validate token by trying to get user
      try {
        const { data: user, error } = await supabase.auth.getUser(access_token);
        if(error || !user) {
          message.textContent = 'Reset link invalid or expired.';
          return;
        }
        message.textContent = '';
        password1.disabled = false;
        password2.disabled = false;

      } catch(e) {
        message.textContent = 'Unexpected error validating link.';
        return;
      }

      // Check passwords match
      function checkPasswords() {
        if(password1.value && password2.value && password1.value === password2.value) {
          resetBtn.disabled = false;
          message.textContent = '';
        } else {
          resetBtn.disabled = true;
          if(password1.value && password2.value && password1.value !== password2.value) {
            message.textContent = 'Passwords do not match';
          } else {
            message.textContent = '';
          }
        }
      }

      password1.addEventListener('input', checkPasswords);
      password2.addEventListener('input', checkPasswords);

      window.togglePassword = function(id) {
        const input = document.getElementById(id);
        input.type = input.type === 'password' ? 'text' : 'password';
      }

      // Reset password
      async function resetPassword() {
        resetBtn.disabled = true;
        message.textContent = 'Resetting password...';
        try {
          const { data, error } = await supabase.auth.updateUser(
            { password: password1.value },
            { access_token: access_token }
          );
          if(error) {
            message.textContent = error.message;
            resetBtn.disabled = false;
          } else {
            message.style.color = 'green';
            message.textContent = 'Password reset successfully! Redirecting...';
            setTimeout(() => {
              window.location.href = 'https://the-turning-point-booking-app.onrender.com';
            }, 2000);
          }
        } catch(e) {
          message.textContent = 'Unexpected error occurred';
          resetBtn.disabled = false;
        }
      }

      resetBtn.addEventListener('click', resetPassword);
    }
  </script>
</body>
</html>
